# Railway Deployment Guide for WellFlow MVP

This guide covers the complete setup of Railway backend infrastructure for the WellFlow MVP, including NestJS API, PostgreSQL with TimescaleDB, and Redis.

## Prerequisites

1. **Railway Account**: Sign up at [railway.app](https://railway.app)
2. **Railway CLI**: Install using `curl -fsSL https://railway.app/install.sh | sh`
3. **Active Railway Plan**: Trial or paid plan required

## Project Structure

```
apps/api/
├── Dockerfile              # Container configuration
├── .dockerignore           # Docker ignore rules
├── railway.json           # Railway deployment config
└── src/                   # NestJS application source
```

## Step 1: Railway Project Setup

### 1.1 Login to Railway
```bash
railway login
```

### 1.2 Initialize Project
```bash
# From project root
railway init
# Enter project name: wellflow-mvp
```

### 1.3 Link to API Directory
```bash
cd apps/api
railway link
# Select the wellflow-mvp project
```

## Step 2: Database Services Setup

### 2.1 Add PostgreSQL with TimescaleDB
```bash
# Add PostgreSQL service
railway add postgresql

# Note: TimescaleDB extension needs to be enabled manually
# Connect to database and run: CREATE EXTENSION IF NOT EXISTS timescaledb;
```

### 2.2 Add Redis Service
```bash
# Add Redis service
railway add redis
```

## Step 3: Environment Variables Configuration

### 3.1 Set Production Environment Variables
```bash
# Database configuration (auto-generated by Railway PostgreSQL service)
railway variables set DATABASE_URL=${{Postgres.DATABASE_URL}}

# Redis configuration (auto-generated by Railway Redis service)
railway variables set REDIS_URL=${{Redis.REDIS_URL}}

# Application configuration
railway variables set NODE_ENV=production
railway variables set PORT=3001

# JWT Configuration
railway variables set JWT_SECRET=your-production-jwt-secret-here
railway variables set JWT_EXPIRES_IN=7d

# CORS Configuration
railway variables set CORS_ORIGINS=https://your-frontend-domain.vercel.app

# Health check configuration
railway variables set HEALTH_CHECK_ENABLED=true
railway variables set METRICS_ENABLED=true

# External services (configure as needed)
railway variables set SENTRY_DSN=your-sentry-dsn
railway variables set RESEND_API_KEY=your-resend-api-key
railway variables set TWILIO_ACCOUNT_SID=your-twilio-sid
railway variables set TWILIO_AUTH_TOKEN=your-twilio-token
```

### 3.2 Environment Variables Reference

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://user:pass@host:port/db` |
| `REDIS_URL` | Redis connection string | `redis://host:port` |
| `NODE_ENV` | Environment mode | `production` |
| `PORT` | Application port | `3001` |
| `JWT_SECRET` | JWT signing secret | `your-secret-key` |
| `CORS_ORIGINS` | Allowed CORS origins | `https://app.vercel.app` |

## Step 4: Deployment Configuration

### 4.1 Railway Configuration (railway.json)
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "Dockerfile"
  },
  "deploy": {
    "numReplicas": 1,
    "sleepApplication": false,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### 4.2 Dockerfile Configuration
- Multi-stage build for optimization
- Node.js 18 Alpine base image
- pnpm package manager
- Health check endpoint
- Non-root user for security

## Step 5: Database Setup

### 5.1 Enable TimescaleDB Extension
```sql
-- Connect to your Railway PostgreSQL database
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- Verify installation
SELECT * FROM pg_extension WHERE extname = 'timescaledb';
```

### 5.2 Run Database Migrations
```bash
# From apps/api directory
railway run pnpm db:migrate
```

### 5.3 Seed Database (Optional)
```bash
# From apps/api directory
railway run pnpm db:seed
```

## Step 6: Deployment

### 6.1 Deploy Application
```bash
# From apps/api directory
railway up
```

### 6.2 Monitor Deployment
```bash
# View deployment logs
railway logs

# Check service status
railway status
```

## Step 7: Health Check Verification

### 7.1 Test Health Endpoints
```bash
# Get your Railway service URL
railway domain

# Test health endpoint
curl https://your-service.railway.app/health

# Test readiness endpoint
curl https://your-service.railway.app/health/ready

# Test liveness endpoint
curl https://your-service.railway.app/health/live
```

### 7.2 Expected Health Response
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 123.456,
  "version": "0.1.0",
  "environment": "production",
  "checks": {
    "database": "healthy",
    "redis": "healthy"
  }
}
```

## Step 8: Custom Domain (Optional)

### 8.1 Add Custom Domain
```bash
railway domain add api.yourdomain.com
```

### 8.2 Configure DNS
- Add CNAME record pointing to Railway domain
- SSL certificate will be automatically provisioned

## Troubleshooting

### Common Issues

1. **Build Failures**
   - Check Dockerfile syntax
   - Verify all dependencies are in package.json
   - Check build logs: `railway logs --build`

2. **Database Connection Issues**
   - Verify DATABASE_URL environment variable
   - Check PostgreSQL service status
   - Ensure TimescaleDB extension is enabled

3. **Redis Connection Issues**
   - Verify REDIS_URL environment variable
   - Check Redis service status
   - Review Redis connection logs

4. **Health Check Failures**
   - Check application logs: `railway logs`
   - Verify all services are running
   - Test individual service connections

### Useful Commands

```bash
# View all environment variables
railway variables

# Connect to database
railway connect postgres

# Connect to Redis
railway connect redis

# View service metrics
railway status

# Restart service
railway restart

# View build logs
railway logs --build

# View application logs
railway logs --tail
```

## Security Considerations

1. **Environment Variables**: Never commit secrets to version control
2. **Database Access**: Use connection pooling and proper timeouts
3. **Redis Security**: Configure appropriate timeout and memory limits
4. **Health Checks**: Ensure endpoints don't expose sensitive information
5. **CORS**: Configure strict CORS origins for production

## Performance Optimization

1. **Database**: Use connection pooling (configured in connection.ts)
2. **Redis**: Implement proper caching strategies
3. **Docker**: Multi-stage builds for smaller images
4. **Health Checks**: Lightweight checks to avoid resource overhead

## Monitoring and Observability

1. **Health Endpoints**: `/health`, `/health/ready`, `/health/live`
2. **Logs**: Structured logging with Winston (to be implemented)
3. **Metrics**: Application metrics collection (to be implemented)
4. **Error Tracking**: Sentry integration (to be configured)

## Next Steps

After successful deployment:

1. Configure monitoring and alerting
2. Set up CI/CD pipeline with GitHub Actions
3. Implement database backup procedures
4. Configure log aggregation
5. Set up performance monitoring
